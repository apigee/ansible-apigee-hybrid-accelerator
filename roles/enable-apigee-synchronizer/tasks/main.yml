# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
# tasks file for enable-apigee-synchronizer
- name: Get Gcloud oAuth Token
  shell: gcloud auth print-access-token
  register: access_token

- name: Get controlPlaneAccess Status
  ansible.builtin.uri:
    url: "{{ overrides.contractProvider | default('https://apigee.googleapis.com') }}/v1/organizations/{{ overrides.gcp.projectID }}/controlPlaneAccess"
    method: GET
    return_content: true
    headers:
      Content-Type: application/json
      Authorization: Bearer {{ access_token.stdout }}
  register: cp_status

- name: Debug controlPlaneAccess Status
  debug:
    msg: "{{ cp_status }}"

- name: Get controlPlaneAccess Info
  set_fact:
    sync_identity: "{{ (cp_status.json.synchronizerIdentities[0] if ('synchronizerIdentities' in cp_status.json) else 'serviceAccount:') | split(':') }}"
    analytics_identity: "{{ (cp_status.json.analyticsPublisherIdentities[0] if ('analyticsPublisherIdentities' in cp_status.json) else 'serviceAccount:') | split(':') }}"

- name: Get Synchronizer Service Account
  set_fact:
    synchronizer_service_account: "{{ synchronizer_prod_svc_account if (deployment_environment == 'prod') else synchronizer_non_prod_svc_account }}@{{ overrides.gcp.projectID }}.iam.gserviceaccount.com"

- name: Enable Synchronizer
  ansible.builtin.uri:
    url: "{{ overrides.contractProvider | default('https://apigee.googleapis.com') }}/v1/organizations/{{ overrides.gcp.projectID }}/controlPlaneAccess?update_mask=synchronizer_identities"
    method: PATCH
    body_format: json
    status_code: [200, 201]
    return_content: true
    headers:
      Content-Type: application/json
      Authorization: Bearer {{ access_token.stdout }}
    body: "{\"synchronizer_identities\":[ \"serviceAccount:{{ synchronizer_service_account }}\"]}"
  register: synchronizer_register
  when: "sync_identity.1 != synchronizer_service_account"

- name: Check Synchronizer Status
  debug:
    msg: "{{ synchronizer_register }}"
  when: "sync_identity.1 != synchronizer_service_account"

- name: Get Runtime Service Account
  set_fact:
    runtime_service_account: "{{ runtime_prod_svc_account if (deployment_environment == 'prod') else runtime_non_prod_svc_account }}@{{ overrides.gcp.projectID }}.iam.gserviceaccount.com"

- name: Enable Analytics
  ansible.builtin.uri:
    url: "{{ overrides.contractProvider | default('https://apigee.googleapis.com') }}/v1/organizations/{{ overrides.gcp.projectID }}/controlPlaneAccess?update_mask=analytics_publisher_identities"
    method: PATCH
    body_format: json
    status_code: [200, 201]
    return_content: true
    headers:
      Content-Type: application/json
      Authorization: Bearer {{ access_token.stdout }}
    body: "{\"analytics_publisher_identities\":[ \"serviceAccount:{{ runtime_service_account }}\"]}"
  register: analytics_register
  when: "analytics_identity.1 != runtime_service_account"

- name: Check Analytics Status
  debug:
    msg: "{{ analytics_register }}"
  when: "analytics_identity.1 != runtime_service_account"
